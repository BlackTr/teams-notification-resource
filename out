#!/usr/bin/env bash

CURL_OPTION="-k"

set -e
exec 3>&1
exec 1>&2
set -x

payload=$(mktemp /tmp/resource-in.XXXXXX)
cat > "${payload}" <&0

format="markdown"
color="$(jq -r '.params.color // "EA4300"' < "${payload}")"

#todo: DRY

actionName="$(jq -r '.params.actionName // "Open Concourse"' < "${payload}")"
# escape ( and ) from markdown
actionName="${actionName//\(/\\(}"
actionName="${actionName//\)/\\)}"
actionName="${actionName//\:/\\:}"
actionName=`eval echo $actionName`

actionTarget="$(jq -r '.params.actionTarget // "https://concourse.ci"' < "${payload}")"
# escape ( and ) from markdown
actionTarget="${actionTarget//\(/\\(}"
actionTarget="${actionTarget//\)/\\)}"
actionTarget="${actionTarget//\:/\\:}"
actionTarget=`eval echo $actionTarget`

title="$(jq -r '.params.title // "Concourse CI"' < "${payload}")"
# escape ( and ) from markdown
title="${title//\(/\\(}"
title="${title//\)/\\)}"
title="${title//\:/\\:}"
title=`eval echo $title`

text="$(jq -r '.params.text // "NO MSG"' < "${payload}")"
# escape ( and ) from markdown
text="${text//\(/\\(}"
text="${text//\)/\\)}"
text="${text//\:/\\:}"
text=`eval echo $text`

#body="{\"TextFormat\": \"${format}\", \"text\": \"${text}\"}"
body="{\"TextFormat\": \"${format}\", \"text\": \"${text}\", \"title\": \"${title}\", \"potentialAction\": [{\"@context\": \"https://schema.org\", \"@type\": \"ViewAction\", \"name\": \"${actionName}\", \"target\": [\"${actionTarget}\"]}]}"

webhook_url="$(jq -r '.source.url' < "${payload}")"
redacted_webhook_url=$(echo "${webhook_url}" | sed -e 's#/\([^/\.]\{2\}\)[^/.]\{5,\}\([^/.]\{2\}\)#/\1â€¦\2#g' | jq -R .)

url_path="$(echo ${webhook_url} | sed -e "s/https\{0,1\}:\/\/[^\/]*\(\/[^?&#]*\).*/\1/")"
curl -v -d "${body}" ${CURL_OPTION} "${webhook_url}" 2>&1 | sed -e "s#${url_path}#***WEBHOOK URL REDACTED***#g"

timestamp=$(date +%s)
metadata="$(cat <<EOF
{
  "version": {"timestamp": "${timestamp}"},
  "metadata": [
    {"name": "url", "value": ${redacted_webhook_url}},
    {"name": "BUILD_PIPELINE_NAME", "value": "${BUILD_PIPELINE_NAME}"}
  ]
}
EOF
)"

echo "$metadata"  >&3

